<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Pos Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Tahoma;background:#f4f6f8;margin:0}
header{background:#0d6efd;color:#fff;padding:15px;text-align:center}
.box{background:#fff;margin:10px;padding:15px;border-radius:6px}
input,button{width:100%;padding:10px;margin-top:5px}
button.primary{background:#0d6efd;color:#fff;border:none}
.hidden{display:none}
</style>
</head>
<body>

<header>ğŸ“Š Pos Pro</header>

<!-- LOGIN -->
<div class="box" id="authBox">
<h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
<input id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
<input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button class="primary" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
<button onclick="register()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
<p id="authMsg"></p>
</div>

<!-- APP -->
<div class="box hidden" id="appBox">
<h3>Ù…Ø±Ø­Ø¨Ù‹Ø§ <span id="userName"></span></h3>

<input id="saleTotal" type="number" placeholder="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
<button class="primary" onclick="saveSale()">ğŸ’¾ Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø©</button>

<p id="status"></p>
<button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const dbCloud = firebase.firestore();

/* ================= OFFLINE DB ================= */
let db;
const req = indexedDB.open("PosProDB",1);
req.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore("sales",{keyPath:"id"});
};
req.onsuccess=e=>db=e.target.result;

/* ================= AUTH ================= */
let currentUser=null;

auth.onAuthStateChanged(async user=>{
  if(user){
    currentUser=user;
    authBox.classList.add("hidden");
    appBox.classList.remove("hidden");
    userName.innerText=user.email;

    checkSubscription();
  }
});

function register(){
  auth.createUserWithEmailAndPassword(email.value,password.value)
  .then(async res=>{
    await dbCloud.collection("users").doc(res.user.uid).set({
      email:res.user.email,
      created:Date.now(),
      trialEnds:Date.now()+14*24*60*60*1000
    });
  }).catch(e=>authMsg.innerText=e.message);
}

function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
  .catch(e=>authMsg.innerText=e.message);
}

function logout(){
  auth.signOut();
  location.reload();
}

/* ================= SUBSCRIPTION ================= */
async function checkSubscription(){
  const doc=await dbCloud.collection("users").doc(currentUser.uid).get();
  const data=doc.data();
  if(Date.now()>data.trialEnds){
    alert("Ø§Ù†ØªÙ‡Øª ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±Ø¨Ø© â€“ Ø¨Ø±Ø¬Ø§Ø¡ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ");
    logout();
  }
}

/* ================= SALES ================= */
function saveSale(){
  const data={
    id:Date.now(),
    uid:currentUser.uid,
    total:+saleTotal.value,
    date:new Date().toISOString()
  };

  const tx=db.transaction("sales","readwrite");
  tx.objectStore("sales").add(data);

  status.innerText="ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª âœ…";
}

/* ================= SYNC ================= */
window.addEventListener("online",syncSales);

function syncSales(){
  const tx=db.transaction("sales","readwrite");
  const store=tx.objectStore("sales");
  store.getAll().onsuccess=e=>{
    e.target.result.forEach(item=>{
      dbCloud.collection("sales")
        .doc(item.uid)
        .collection("invoices")
        .add(item);
      store.delete(item.id);
    });
    status.innerText="ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± ğŸ”";
  };
}

/* ================= SERVICE WORKER ================= */
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
