<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Pos Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Tahoma;background:#f4f6f8;margin:0}
header{background:#0d6efd;color:#fff;padding:15px;text-align:center}
.box{background:#fff;margin:10px;padding:15px;border-radius:6px}
input,button{width:100%;padding:10px;margin-top:5px}
button.primary{background:#0d6efd;color:#fff;border:none}
button.red{background:#dc3545;color:#fff;border:none}
.hidden{display:none}
</style>
</head>
<body>

<header>ğŸ“Š Pos Pro</header>

<!-- AUTH -->
<div class="box" id="authBox">
<h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
<input id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
<input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button class="primary" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
<button onclick="register()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
<p id="authMsg"></p>
</div>

<!-- APP -->
<div class="hidden" id="appBox">

<div class="box">
<h3>Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹ <span id="userName"></span></h3>
<button class="red" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<!-- SALES -->
<div class="box">
<h4>ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h4>
<input id="saleTotal" type="number" placeholder="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
<button class="primary" onclick="saveSale()">Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
</div>

<!-- EXPENSES -->
<div class="box">
<h4>ğŸ’¸ Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h4>
<input id="expenseAmount" type="number" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ">
<input id="expenseNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©">
<button class="primary" onclick="saveExpense()">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
</div>

<!-- INVOICES -->
<div class="box">
<h4>ğŸ“„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h4>
<div id="invoiceList"></div>
</div>

<!-- REPORTS -->
<div class="box">
<h4>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h4>
<button onclick="generateReport()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
<div id="reportBox"></div>
</div>

<p id="status"></p>
</div>

<script>
/* FIREBASE */
const firebaseConfig={
  apiKey:"YOUR_API_KEY",
  authDomain:"YOUR_PROJECT.firebaseapp.com",
  projectId:"YOUR_PROJECT"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();

/* OFFLINE DB */
let db;
const req=indexedDB.open("PosProDB",1);
req.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore("sales",{keyPath:"id"});
  db.createObjectStore("expenses",{keyPath:"id"});
};
req.onsuccess=e=>db=e.target.result;

/* AUTH */
let currentUser=null;
auth.onAuthStateChanged(user=>{
  if(user){
    currentUser=user;
    authBox.classList.add("hidden");
    appBox.classList.remove("hidden");
    userName.innerText=user.email;
    loadInvoices();
  }
});

function register(){
  auth.createUserWithEmailAndPassword(email.value,password.value)
  .catch(e=>authMsg.innerText=e.message);
}
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
  .catch(e=>authMsg.innerText=e.message);
}
function logout(){
  auth.signOut();location.reload();
}

/* SALES */
function saveSale(){
  const invoice={
    id:Date.now(),
    uid:currentUser.uid,
    number:"INV-"+Date.now(),
    total:+saleTotal.value,
    date:new Date().toISOString()
  };
  const tx=db.transaction("sales","readwrite");
  tx.objectStore("sales").add(invoice);
  saleTotal.value="";
  loadInvoices();
  status.innerText="ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© âœ…";
}

/* EXPENSES */
function saveExpense(){
  const exp={
    id:Date.now(),
    uid:currentUser.uid,
    amount:+expenseAmount.value,
    note:expenseNote.value,
    date:new Date().toISOString()
  };
  const tx=db.transaction("expenses","readwrite");
  tx.objectStore("expenses").add(exp);
  expenseAmount.value="";
  expenseNote.value="";
  status.innerText="ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ âœ…";
}

/* LOAD INVOICES */
function loadInvoices(){
  const tx=db.transaction("sales","readonly");
  tx.objectStore("sales").getAll().onsuccess=e=>{
    invoiceList.innerHTML="";
    e.target.result.filter(i=>i.uid===currentUser.uid)
    .forEach(i=>{
      invoiceList.innerHTML+=`
      <div class="box">
        ${i.number}<br>
        ${new Date(i.date).toLocaleString("ar-EG")}<br>
        Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${i.total} Ø¬
        <button onclick="printInvoice('${i.number}',${i.total})">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>`;
    });
  };
}

/* REPORT */
function generateReport(){
  let sales=0,expenses=0;
  db.transaction("sales","readonly").objectStore("sales")
  .getAll().onsuccess=e=>{
    e.target.result.filter(i=>i.uid===currentUser.uid)
    .forEach(i=>sales+=i.total);

    db.transaction("expenses","readonly").objectStore("expenses")
    .getAll().onsuccess=x=>{
      x.target.result.filter(i=>i.uid===currentUser.uid)
      .forEach(i=>expenses+=i.amount);

      reportBox.innerHTML=`
      <div class="box">
      Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${sales} Ø¬<br>
      Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${expenses} Ø¬<br>
      <b>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${sales-expenses} Ø¬</b>
      </div>`;
    };
  };
}

/* PRINT */
function printInvoice(num,total){
  const w=window.open("");
  w.document.write(`<h2>Pos Pro</h2><p>${num}</p><p>${total} Ø¬Ù†ÙŠÙ‡</p>`);
  w.print();
}
</script>

</body>
</html>
